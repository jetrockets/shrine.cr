<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 1.2.2">
<meta name="crystal_docs.project_version" content="master">
<meta name="crystal_docs.project_name" content="shrine">



<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/doc.js"></script>

  <meta name="repository-name" content="shrine">
  <title>shrine master</title>
  <script type="text/javascript">
  CrystalDocs.base_path = "";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="index.html">
          shrine
        </a>
      </h1>

      <span class="project-version">
        master
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="shrine/Shrine" data-name="shrine">
      <a href="Shrine.html">Shrine</a>
      
        <ul>
  
  <li class="parent " data-id="shrine/Shrine/Attacher" data-name="shrine::attacher">
      <a href="Shrine/Attacher.html">Attacher</a>
      
        <ul>
  
  <li class=" " data-id="shrine/Shrine/Attacher/ClassMethods" data-name="shrine::attacher::classmethods">
      <a href="Shrine/Attacher/ClassMethods.html">ClassMethods</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Attacher/InstanceMethods" data-name="shrine::attacher::instancemethods">
      <a href="Shrine/Attacher/InstanceMethods.html">InstanceMethods</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="shrine/Shrine/ClassMethods" data-name="shrine::classmethods">
      <a href="Shrine/ClassMethods.html">ClassMethods</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Error" data-name="shrine::error">
      <a href="Shrine/Error.html">Error</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/FileNotFound" data-name="shrine::filenotfound">
      <a href="Shrine/FileNotFound.html">FileNotFound</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/HabitatSettings" data-name="shrine::habitatsettings">
      <a href="Shrine/HabitatSettings.html">HabitatSettings</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/InstanceMethods" data-name="shrine::instancemethods">
      <a href="Shrine/InstanceMethods.html">InstanceMethods</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/InvalidFile" data-name="shrine::invalidfile">
      <a href="Shrine/InvalidFile.html">InvalidFile</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/NotCached" data-name="shrine::notcached">
      <a href="Shrine/NotCached.html">NotCached</a>
      
    </li>
  
  <li class="parent " data-id="shrine/Shrine/Plugins" data-name="shrine::plugins">
      <a href="Shrine/Plugins.html">Plugins</a>
      
        <ul>
  
  <li class="parent " data-id="shrine/Shrine/Plugins/AddMetadata" data-name="shrine::plugins::addmetadata">
      <a href="Shrine/Plugins/AddMetadata.html">AddMetadata</a>
      
        <ul>
  
  <li class=" " data-id="shrine/Shrine/Plugins/AddMetadata/InstanceMethods" data-name="shrine::plugins::addmetadata::instancemethods">
      <a href="Shrine/Plugins/AddMetadata/InstanceMethods.html">InstanceMethods</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="shrine/Shrine/Plugins/Column" data-name="shrine::plugins::column">
      <a href="Shrine/Plugins/Column.html">Column</a>
      
        <ul>
  
  <li class=" " data-id="shrine/Shrine/Plugins/Column/AttacherClassMethods" data-name="shrine::plugins::column::attacherclassmethods">
      <a href="Shrine/Plugins/Column/AttacherClassMethods.html">AttacherClassMethods</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Plugins/Column/AttacherMethods" data-name="shrine::plugins::column::attachermethods">
      <a href="Shrine/Plugins/Column/AttacherMethods.html">AttacherMethods</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Plugins/Column/BaseSerializer" data-name="shrine::plugins::column::baseserializer">
      <a href="Shrine/Plugins/Column/BaseSerializer.html">BaseSerializer</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Plugins/Column/JsonSerializer" data-name="shrine::plugins::column::jsonserializer">
      <a href="Shrine/Plugins/Column/JsonSerializer.html">JsonSerializer</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="shrine/Shrine/Plugins/DetermineMimeType" data-name="shrine::plugins::determinemimetype">
      <a href="Shrine/Plugins/DetermineMimeType.html">DetermineMimeType</a>
      
        <ul>
  
  <li class=" " data-id="shrine/Shrine/Plugins/DetermineMimeType/ClassMethods" data-name="shrine::plugins::determinemimetype::classmethods">
      <a href="Shrine/Plugins/DetermineMimeType/ClassMethods.html">ClassMethods</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Plugins/DetermineMimeType/InstanceMethods" data-name="shrine::plugins::determinemimetype::instancemethods">
      <a href="Shrine/Plugins/DetermineMimeType/InstanceMethods.html">InstanceMethods</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Plugins/DetermineMimeType/MimeTypeAnalyzer" data-name="shrine::plugins::determinemimetype::mimetypeanalyzer">
      <a href="Shrine/Plugins/DetermineMimeType/MimeTypeAnalyzer.html">MimeTypeAnalyzer</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Plugins/DetermineMimeType/Tools" data-name="shrine::plugins::determinemimetype::tools">
      <a href="Shrine/Plugins/DetermineMimeType/Tools.html">Tools</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="shrine/Shrine/Plugins/StoreDimensions" data-name="shrine::plugins::storedimensions">
      <a href="Shrine/Plugins/StoreDimensions.html">StoreDimensions</a>
      
        <ul>
  
  <li class=" " data-id="shrine/Shrine/Plugins/StoreDimensions/ClassMethods" data-name="shrine::plugins::storedimensions::classmethods">
      <a href="Shrine/Plugins/StoreDimensions/ClassMethods.html">ClassMethods</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Plugins/StoreDimensions/DimensionsAnalyzer" data-name="shrine::plugins::storedimensions::dimensionsanalyzer">
      <a href="Shrine/Plugins/StoreDimensions/DimensionsAnalyzer.html">DimensionsAnalyzer</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Plugins/StoreDimensions/FileMethods" data-name="shrine::plugins::storedimensions::filemethods">
      <a href="Shrine/Plugins/StoreDimensions/FileMethods.html">FileMethods</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Plugins/StoreDimensions/IdentifyAnalyzer" data-name="shrine::plugins::storedimensions::identifyanalyzer">
      <a href="Shrine/Plugins/StoreDimensions/IdentifyAnalyzer.html">IdentifyAnalyzer</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Plugins/StoreDimensions/InstanceMethods" data-name="shrine::plugins::storedimensions::instancemethods">
      <a href="Shrine/Plugins/StoreDimensions/InstanceMethods.html">InstanceMethods</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Plugins/StoreDimensions/Tools" data-name="shrine::plugins::storedimensions::tools">
      <a href="Shrine/Plugins/StoreDimensions/Tools.html">Tools</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="shrine/Shrine/PluginSettings" data-name="shrine::pluginsettings">
      <a href="Shrine/PluginSettings.html">PluginSettings</a>
      
    </li>
  
  <li class="parent " data-id="shrine/Shrine/Storage" data-name="shrine::storage">
      <a href="Shrine/Storage.html">Storage</a>
      
        <ul>
  
  <li class=" " data-id="shrine/Shrine/Storage/Base" data-name="shrine::storage::base">
      <a href="Shrine/Storage/Base.html">Base</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Storage/FileSystem" data-name="shrine::storage::filesystem">
      <a href="Shrine/Storage/FileSystem.html">FileSystem</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Storage/Memory" data-name="shrine::storage::memory">
      <a href="Shrine/Storage/Memory.html">Memory</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/Storage/S3" data-name="shrine::storage::s3">
      <a href="Shrine/Storage/S3.html">S3</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="shrine/Shrine/UploadedFile" data-name="shrine::uploadedfile">
      <a href="Shrine/UploadedFile.html">UploadedFile</a>
      
        <ul>
  
  <li class=" " data-id="shrine/Shrine/UploadedFile/Mapper" data-name="shrine::uploadedfile::mapper">
      <a href="Shrine/UploadedFile/Mapper.html">Mapper</a>
      
    </li>
  
  <li class=" " data-id="shrine/Shrine/UploadedFile/MetadataType" data-name="shrine::uploadedfile::metadatatype">
      <a href="Shrine/UploadedFile/MetadataType.html">MetadataType</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<p><img src="logo/shrine-cr-logo-small.png" alt="Shrine Logo" /></p>
<h1><a id="shrine.cr" class="anchor" href="#shrine.cr">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>shrine.cr</h1>
<p><a href="https://github.com/jetrockets/shrine.cr/actions"><img src="https://github.com/jetrockets/shrine.cr/workflows/specs/badge.svg?branch=master" alt="Build Status" /></a>
<a href="https://GitHub.com/jetrockets/shrine.cr/releases/"><img src="https://img.shields.io/github/release/jetrockets/shrine.cr.svg" alt="GitHub release" /></a>
<a href="https://github.com/jetrockets/shrine.cr/blob/master/LICENSE"><img src="https://img.shields.io/github/license/jetrockets/shrine.cr" alt="GitHub license" /></a>
<a href="https://gitter.im/shrine-cr/community?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://badges.gitter.im/shrine-cr/community.svg" alt="Join the chat at https://gitter.im/shrine-cr/community" /></a></p>
<p>Shrine is a toolkit for file attachments in Crystal applications. Heavily inspired by <a href="https://shrinerb.com">Shrine for Ruby</a>.</p>
<h2><a id="documentation" class="anchor" href="#documentation">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Documentation</h2>
<p><a href="https://jetrockets.github.io/shrine.cr">https://jetrockets.github.io/shrine.cr</a></p>
<h2><a id="installation" class="anchor" href="#installation">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Installation</h2>
<ol>
<li>
<p>Add the dependency to your <code>shard.yml</code>:</p>
<pre><code class="language-yaml">dependencies:
  shrine:
    github: jetrockets/shrine.cr</code></pre>
</li>
<li>
<p>Run <code>shards install</code></p>
</li>
</ol>
<h2><a id="usage" class="anchor" href="#usage">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Usage</h2>
<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;shrine&quot;</span></code></pre>
<p>Shrine.cr is under heavy development!</p>
<p>First of all you should configure <code><a href="Shrine.html">Shrine</a></code>.</p>
<pre><code class="language-crystal"><span class="t">Shrine</span>.configure <span class="k">do</span> <span class="o">|</span>config<span class="o">|</span>
  config.storages[<span class="s">&quot;cache&quot;</span>] <span class="o">=</span> <span class="t">Storage</span><span class="t">::</span><span class="t">FileSystem</span>.<span class="k">new</span>(<span class="s">&quot;uploads&quot;</span>, prefix: <span class="s">&quot;cache&quot;</span>)
  config.storages[<span class="s">&quot;store&quot;</span>] <span class="o">=</span> <span class="t">Storage</span><span class="t">::</span><span class="t">FileSystem</span>.<span class="k">new</span>(<span class="s">&quot;uploads&quot;</span>)
<span class="k">end</span></code></pre>
<p>Now you can use <code><a href="Shrine.html">Shrine</a></code> directly to upload your files.</p>
<pre><code class="language-crystal"><span class="t">Shrine</span>.upload(file, <span class="s">&quot;store&quot;</span>)</code></pre>
<p><code>Shrine.upload</code> method supports additional argument just like Shrine.rb. For example we want our file to have a custom filename.</p>
<pre><code class="language-crystal"><span class="t">Shrine</span>.upload(file, <span class="s">&quot;store&quot;</span>, metadata: { <span class="s">&quot;filename&quot;</span> =&gt; <span class="s">&quot;foo.bar&quot;</span> })</code></pre>
<h3><a id="custom-uploaders" class="anchor" href="#custom-uploaders">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Custom uploaders</h3>
<p>To implement custom uploader class just inherit it from <code><a href="Shrine.html">Shrine</a></code>. You can override <code><a href="Shrine.html">Shrine</a></code> methods to implement custom logic. Here is an example how to create a custom file location.</p>
<pre><code class="language-crystal"><span class="k">class</span> <span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span> <span class="o">&lt;</span> <span class="t">Shrine</span>
  <span class="k">def</span> <span class="m">generate_location</span>(io : <span class="t">IO</span> <span class="o">|</span> <span class="t">UploadedFile</span>, metadata, context, <span class="o">**</span>options)
    name <span class="o">=</span> <span class="k">super</span>(io, metadata, <span class="o">**</span>options)

    <span class="t">File</span>.join(<span class="s">&quot;imports&quot;</span>, context[<span class="n">:model</span>].id.to_s, name)
  <span class="k">end</span>
<span class="k">end</span>

<span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span>.upload(file, <span class="s">&quot;store&quot;</span>, context: { model: <span class="t">YOUR_ORM_MODEL</span> } })</code></pre>
<h3><a id="s3-storage" class="anchor" href="#s3-storage">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>S3 storage</h3>
<h4><a id="creating-a-client" class="anchor" href="#creating-a-client">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Creating a Client</h4>
<pre><code class="language-crystal">client <span class="o">=</span> <span class="t">Awscr</span><span class="t">::</span><span class="t">S3</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>(<span class="s">&quot;region&quot;</span>, <span class="s">&quot;key&quot;</span>, <span class="s">&quot;secret&quot;</span>)</code></pre>
<p>For S3 compatible services, like DigitalOcean Spaces or Minio, you'll need to set a custom endpoint:</p>
<pre><code class="language-crystal">client <span class="o">=</span> <span class="t">Awscr</span><span class="t">::</span><span class="t">S3</span><span class="t">::</span><span class="t">Client</span>.<span class="k">new</span>(<span class="s">&quot;nyc3&quot;</span>, <span class="s">&quot;key&quot;</span>, <span class="s">&quot;secret&quot;</span>, endpoint: <span class="s">&quot;https://nyc3.digitaloceanspaces.com&quot;</span>)</code></pre>
<h4><a id="create-a-s3-storage" class="anchor" href="#create-a-s3-storage">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Create a S3 storage</h4>
<p>The storage is initialized by providing your bucket and client:</p>
<pre><code class="language-crystal">storage <span class="o">=</span> <span class="t">Shrine</span><span class="t">::</span><span class="t">Storage</span><span class="t">::</span><span class="t">S3</span>.<span class="k">new</span>(bucket: <span class="s">&quot;bucket_name&quot;</span>, client: client, prefix: <span class="s">&quot;prefix&quot;</span>)</code></pre>
<p>Sometimes you'll want to add additional upload options to all S3 uploads. You can do that by passing the :upload_options option:</p>
<pre><code class="language-crystal">storage <span class="o">=</span> <span class="t">Shrine</span><span class="t">::</span><span class="t">Storage</span><span class="t">::</span><span class="t">S3</span>.<span class="k">new</span>(bucket: <span class="s">&quot;bucket_name&quot;</span>, client: client, upload_options: { <span class="s">&quot;x-amz-acl&quot;</span>=&gt; <span class="s">&quot;public-read&quot;</span> })</code></pre>
<p>You can tell S3 storage to make uploads public:</p>
<pre><code class="language-crystal">storage <span class="o">=</span> <span class="t">Shrine</span><span class="t">::</span><span class="t">Storage</span><span class="t">::</span><span class="t">S3</span>.<span class="k">new</span>(bucket: <span class="s">&quot;bucket_name&quot;</span>, client: client, public: <span class="n">true</span>)</code></pre>
<h3><a id="orm-usage-example" class="anchor" href="#orm-usage-example">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>ORM usage example</h3>
<p>Currently ORM adapters are not implmented.</p>
<h4><a id="granite." class="anchor" href="#granite.">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Granite.</h4>
<pre><code class="language-crystal"><span class="k">class</span> <span class="t">FileImport</span> <span class="o">&lt;</span> <span class="t">Granite</span><span class="t">::</span><span class="t">Base</span>
  connection pg
  table file_imports

  column id : <span class="t">Int64</span>, primary: <span class="n">true</span>
  column asset_data : <span class="t">Shrine</span><span class="t">::</span><span class="t">UploadedFile</span>, converter: <span class="t">Granite</span><span class="t">::</span><span class="t">Converters</span><span class="t">::</span><span class="t">Json</span>(<span class="t">Shrine</span><span class="t">::</span><span class="t">UploadedFile</span>, <span class="t">JSON</span><span class="t">::</span><span class="t">Any</span>)

  after_save <span class="k">do</span>
    <span class="k">if</span> @asset_changed &amp;&amp; @asset_data
      @asset_data <span class="o">=</span> <span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span>.store(@asset_data.not_nil!, move: <span class="n">true</span>, context: { model: <span class="k">self</span> })
      @asset_changed <span class="o">=</span> <span class="n">false</span>

      save!
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">asset</span><span class="o">=</span>(upload : <span class="t">Amber</span><span class="t">::</span><span class="t">Router</span><span class="t">::</span><span class="t">File</span>)
    @asset_data <span class="o">=</span> <span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span>.cache(upload.file, metadata: { filename: upload.filename })
    @asset_changed <span class="o">=</span> <span class="n">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<h4><a id="jennifer" class="anchor" href="#jennifer">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Jennifer</h4>
<pre><code class="language-crystal"><span class="k">class</span> <span class="t">FileImport</span> <span class="o">&lt;</span> <span class="t">Jennifer</span><span class="t">::</span><span class="t">Model</span><span class="t">::</span><span class="t">Base</span>
  @asset_changed : <span class="t">Bool</span> <span class="o">|</span> <span class="t">Nil</span>

  with_timestamps

  mapping(
    id: <span class="t">Primary32</span>,
    asset_data: <span class="t">JSON</span><span class="t">::</span><span class="t">Any</span>?,
    created_at: <span class="t">Time</span>?,
    updated_at: <span class="t">Time</span>?
  )

  after_save <span class="n">:move_to_store</span>

  <span class="k">def</span> <span class="m">asset</span><span class="o">=</span>(upload : <span class="t">Amber</span><span class="t">::</span><span class="t">Router</span><span class="t">::</span><span class="t">File</span>)
    <span class="k">self</span>.asset_data <span class="o">=</span> <span class="t">JSON</span>.parse(<span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span>.cache(upload.file, metadata: { filename: upload.filename }).to_json)
    asset_changed! <span class="k">if</span> asset_data
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">asset</span>
    <span class="t">Shrine</span><span class="t">::</span><span class="t">UploadedFile</span>.from_json(asset_data.not_nil!.to_json) <span class="k">if</span> asset_data
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">asset_changed?</span>
    @asset_changed || <span class="n">false</span>
  <span class="k">end</span>

  <span class="k">private</span> <span class="k">def</span> <span class="m">asset_changed!</span>
    @asset_changed <span class="o">=</span> <span class="n">true</span>
  <span class="k">end</span>

  <span class="k">private</span> <span class="k">def</span> <span class="m">move_to_store</span>
    <span class="k">if</span> asset_changed?
      <span class="k">self</span>.asset_data <span class="o">=</span> <span class="t">JSON</span>.parse(<span class="t">FileImport</span><span class="t">::</span><span class="t">AssetUploader</span>.store(asset.not_nil!, move: <span class="n">true</span>, context: { model: <span class="k">self</span> }).to_json)
      @asset_changed <span class="o">=</span> <span class="n">false</span>
      save!
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<h2><a id="plugins" class="anchor" href="#plugins">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Plugins</h2>
<p>Shrine.cr has a plugins interface similar to Shrine.rb. You can extend functionality of uploaders inherited from <code><a href="Shrine.html">Shrine</a></code> and also extend <code>UploadedFile</code> class.</p>
<h3><a id="determine-mime-type" class="anchor" href="#determine-mime-type">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Determine MIME Type</h3>
<p>The <code>DetermineMimeType</code> plugin is used to get mime type of uploaded file in several ways.</p>
<pre><code class="language-crystal">
<span class="k">require</span> <span class="s">&quot;shrine/plugins/determine_mime_type&quot;</span>

<span class="k">class</span> <span class="t">Uploader</span> <span class="o">&lt;</span> <span class="t">Shrine</span>
  load_plugin(
    <span class="t">Shrine</span><span class="t">::</span><span class="t">Plugins</span><span class="t">::</span><span class="t">DetermineMimeType</span>,
    analyzer: <span class="t">Shrine</span><span class="t">::</span><span class="t">Plugins</span><span class="t">::</span><span class="t">DetermineMimeType</span><span class="t">::</span><span class="t">Tools</span><span class="t">::</span><span class="t">File</span>
  )

  finalize_plugins!
<span class="k">end</span></code></pre>
<p><strong>Analyzers</strong></p>
<p>The following analyzers are accepted:</p>
<p>| Name | Description |
| --- | --- |
| <code>File</code>| (<strong>Default</strong>). Uses the file utility to determine the MIME type from file contents. It is installed by default on most operating systems. |
| <code>Mime</code> | Uses the <a href="https://crystal-lang.org/api/0.31.1/MIME.html">MIME.from_filename</a> method to determine the MIME type from file.|
| <code>ContentType</code> | Retrieves the value of the <code>#content_type</code> attribute of the IO object. Note that this value normally comes from the &quot;Content-Type&quot; request header, so it's not guaranteed to hold the actual MIME type of the file. |</p>
<h3><a id="add-metadata" class="anchor" href="#add-metadata">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Add Metadata</h3>
<p>The <code>AddMetadata</code> plugin provides a convenient method for extracting and adding custom metadata values.</p>
<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;base64&quot;</span>
<span class="k">require</span> <span class="s">&quot;shrine/plugins/add_metadata&quot;</span>

<span class="k">class</span> <span class="t">Uploader</span> <span class="o">&lt;</span> <span class="t">Shrine</span>
  load_plugin(<span class="t">Shrine</span><span class="t">::</span><span class="t">Plugins</span><span class="t">::</span><span class="t">AddMetadata</span>)

  add_metadata <span class="n">:signature</span>, -&gt; {
    <span class="t">Base64</span>.encode(io.gets_to_end)
  }

  finalize_plugins!
<span class="k">end</span></code></pre>
<p>The above will add <code>&quot;signature&quot;</code> to the metadata hash.</p>
<pre><code class="language-crystal">image.metadata[<span class="s">&quot;signature&quot;</span>]</code></pre>
<p><strong>Multiple values</strong></p>
<p>You can also extract multiple metadata values at once.</p>
<pre><code class="language-crystal"><span class="k">class</span> <span class="t">Uploader</span> <span class="o">&lt;</span> <span class="t">Shrine</span>
  load_plugin(<span class="t">Shrine</span><span class="t">::</span><span class="t">Plugins</span><span class="t">::</span><span class="t">AddMetadata</span>)

  add_metadata <span class="n">:multiple_values</span>, -&gt; {
    text <span class="o">=</span> io.gets_to_end

    <span class="t">Shrine</span><span class="t">::</span><span class="t">UploadedFile</span><span class="t">::</span><span class="t">MetadataType</span>{
      <span class="s">&quot;custom_1&quot;</span> =&gt; text,
      <span class="s">&quot;custom_2&quot;</span> =&gt; text <span class="o">*</span> <span class="n">2</span>
    }
  }

  finalize_plugins!
<span class="k">end</span></code></pre>
<pre><code class="language-crystal">image.metadata[<span class="s">&quot;custom_1&quot;</span>]
image.metadata[<span class="s">&quot;custom_2&quot;</span>]</code></pre>
<h3><a id="store-dimensions" class="anchor" href="#store-dimensions">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Store Dimensions</h3>
<p>The <code>StoreDimensions</code> plugin extracts dimensions of uploaded images and stores them into the metadata. Additional dependency <a href="https://github.com/jetrockets/fastimage.cr">https://github.com/jetrockets/fastimage.cr</a> needed for this plugin.</p>
<pre><code class="language-crystal">
<span class="k">require</span> <span class="s">&quot;fastimage&quot;</span>
<span class="k">require</span> <span class="s">&quot;shrine/plugins/store_dimensions&quot;</span>

<span class="k">class</span> <span class="t">Uploader</span> <span class="o">&lt;</span> <span class="t">Shrine</span>
  load_plugin(<span class="t">Shrine</span><span class="t">::</span><span class="t">Plugins</span><span class="t">::</span><span class="t">StoreDimensions</span>,
    analyzer: <span class="t">Shrine</span><span class="t">::</span><span class="t">Plugins</span><span class="t">::</span><span class="t">StoreDimensions</span><span class="t">::</span><span class="t">Tools</span><span class="t">::</span><span class="t">FastImage</span>)

  finalize_plugins!
<span class="k">end</span></code></pre>
<pre><code class="language-crystal">image.metadata[<span class="s">&quot;width&quot;</span>]
image.metadata[<span class="s">&quot;height&quot;</span>]</code></pre>
<p><strong>Analyzers</strong></p>
<p>The following analyzers are accepted:</p>
<p>| Name | Description |
| --- | --- |
| <code>FastImage</code> | (<strong>Default</strong>) Uses the <a href="https://github.com/jetrockets/fastimage.cr">FastImage</a>. |
| <code>Identify</code> | A built-in solution that wrapps ImageMagick's <code>identify</code> command. |</p>
<h2><a id="feature-progress" class="anchor" href="#feature-progress">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Feature Progress</h2>
<p>In no particular order, features that have been implemented and are planned.
Items not marked as completed may have partial implementations.</p>
<ul>
<li>[X] Shrine</li>
<li>[X] Shrine::UploadedFile
<ul>
<li>[ ] ==</li>
<li>[X] #original_filename</li>
<li>[X] #extension</li>
<li>[X] #size</li>
<li>[X] #mime_type</li>
<li>[X] #close</li>
<li>[X] #url</li>
<li>[X] #exists?</li>
<li>[X] #open</li>
<li>[X] #download</li>
<li>[X] #stream</li>
<li>[X] #replace</li>
<li>[X] #delete</li>
</ul>
</li>
<li>[X] Shrine::Attacher</li>
<li>[ ] Shrine::Attachment</li>
<li>[ ] Shrine::Storage
<ul>
<li>[X] Shrine::Storage::Memory</li>
<li>[X] Shrine::Storage::FileSystem</li>
<li>[X] Shrine::Storage::S3</li>
</ul>
</li>
<li>[ ] Uploaders
<ul>
<li>[X] Custom uploaders</li>
<li>[ ] Derivatives</li>
</ul>
</li>
<li>[ ] ORM adapters
<ul>
<li>[ ] <code>Granite</code> <a href="https://github.com/amberframework/granite">https://github.com/amberframework/granite</a></li>
<li>[ ] <code>crecto</code> <a href="https://github.com/Crecto/crecto">https://github.com/Crecto/crecto</a></li>
<li>[ ] <code>jennifer.cr</code> <a href="https://github.com/imdrasil/jennifer.cr">https://github.com/imdrasil/jennifer.cr</a></li>
<li>[ ] <code>Avram</code> <a href="https://github.com/luckyframework/avram">https://github.com/luckyframework/avram</a></li>
</ul>
</li>
<li>[X] Plugins</li>
<li>[ ] Background processing</li>
</ul>
<h2><a id="contributing" class="anchor" href="#contributing">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributing</h2>
<ol>
<li>Fork it (<a href="https://github.com/your-github-user/shrine.cr/fork">https://github.com/your-github-user/shrine.cr/fork</a>)</li>
<li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li>
<li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li>
<li>Push to the branch (<code>git push origin my-new-feature</code>)</li>
<li>Create a new Pull Request</li>
</ol>
<h2><a id="contributors" class="anchor" href="#contributors">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributors</h2>
<ul>
<li><a href="https://github.com/igor-alexandrov">Igor Alexandrov</a> - creator and maintainer</li>
<li><a href="https://github.com/arina1004">Arina Shmeleva</a> - helped with S3 Storage</li>
<li><a href="https://github.com/wout">Mick Wout</a> - Plugins and Lucky integration</li>
</ul>
</div>
</body>
</html>
